---
description: "Work package task list template for feature implementation"
---

# Work Packages: Agentic CAD Environment

**Inputs**: Design documents from `/kitty-specs/001-agentic-cad-environment/`
**Prerequisites**: plan.md (required), spec.md (user stories)

**Tests**: Tests are included where critical for the infrastructure.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`.

**Precedence Note**: Implementation details for the Simulation Engine are defined in **Spec 003**. Tasks in Spec 003 take priority for the simulation backend. Spec 001 focuses on the Environment loop and tool integration.

## Subtask Format: `[Txxx] [P?] Description`

- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

## Path Conventions

- **Single project**: `src/`

---

## Work Package WP01: Setup, Persistence & Foundation (Priority: P0)

**Goal**: Establish project skeleton, dependencies, and the data persistence layer.
**Independent Test**: Project bootstraps, tests run, and SQLite database schemas are correctly created and queryable.
**Prompt**: `/tasks/WP01-setup-and-persistence.md`

### Included Subtasks

- [x] T001 Create project directory structure per implementation plan (`src/environment`, `src/workbenches`, `src/compiler`, `src/rag`)
- [x] T002 Initialize Python project with `uv` (or poetry) and add dependencies (`build123d`, `mujoco`, `gymnasium`, `numpy`, `sqlalchemy`, `alembic`)
- [x] T003 [P] Configure development tooling (linting, formatting, pre-commit)
- [x] T004 Define SQLAlchemy models in `src/environment/persistence.py` (Episodes, Steps, Artifacts)
- [x] T005 [P] Initialize Alembic for database migrations in `src/migrations/`
- [x] T006 Implement data access methods in `src/environment/persistence.py` using SQLAlchemy sessions (log_step, save_artifact, etc.)

### Implementation Notes

- Use SQLAlchemy ORM with an async (optional) or sync engine.
- Use Alembic for any schema changes.
- Ensure foreign keys are handled by the ORM.

### Parallel Opportunities

- T003 can be done in parallel with T004/T005.

### Dependencies

- None.

### Risks & Mitigations

- Schema changes later might be painful; keep it flexible (JSON fields for tool_inputs/outputs).

---

## Work Package WP02: Geometry & Workbenches (Priority: P1)

**Goal**: Implement the CAD geometry compilation and the Workbench constraint system.
**Independent Test**: Can generate meshes from code and validate them against the 3D printing workbench.
**Prompt**: `/tasks/WP02-geometry-and-workbenches.md`

### Included Subtasks

- [x] T006 Implement `src/compiler/geometry.py` - Mesh export from `build123d` objects
- [x] T007 Implement `src/compiler/geometry.py` - Convex decomposition (or basic hull approximation) for physics
- [x] T008 Implement `src/workbenches/base.py` (Abstract Base Class)
- [x] T009 [P] Implement `src/workbenches/print_3d.py` - Geometric Checks (Manifold, SingleBody)
- [x] T010 [P] Implement `src/workbenches/print_3d.py` - Cost Model

### Implementation Notes

- `build123d` has `export_stl` or internal meshing; use that.
- Convex decomposition might need `coacd` or similar if `build123d` doesn't provide it natively, or just use primitive approximation for MVP.

### Parallel Opportunities

- T009 and T010 are parallelizable.

### Dependencies

- WP01 (Dependencies installed).

### Risks & Mitigations

- Complex geometry might fail decomposition; add error handling.

---

## Work Package WP03: Simulation Integration (Priority: P1)

**Goal**: Implement the client interface to the Spec 003 Simulation Engine.
**Independent Test**: Can send a CAD design and control script to the Simulation Engine API and receive a valid JSON report.
**Prompt**: `/tasks/WP03-simulation-integration.md`

### Included Subtasks

- [x] T011 [P] Implement `src/compiler/sim_client.py` - HTTP Client/Wrapper to call Spec 003 API
- [x] T012 Define the simulation request payload (Design STL + Control Script + Scenario)
- [x] T013 Implement response parsing and metric mapping (Engine result -> Gym reward)
- [x] T014 [P] Create a mock/stub simulation service for local testing without Spec 003 running

### Implementation Notes

- Use `mujoco` python bindings.
- Need a dummy/template XML to test against.

### Parallel Opportunities

- T012 and T013 are sequential mostly.

### Dependencies

- WP02 (Needs geometry compiler).

### Risks & Mitigations

- MuJoCo can be tricky to install; assume standard pip install works.

---

## Work Package WP04: Environment Tools & RAG (Priority: P2)

**Goal**: Implement the agent-facing tools including RAG, Code Editing, and Preview.
**Independent Test**: Tools can be called individually and return expected outputs (images, text, status).
**Prompt**: `/tasks/WP04-environment-tools.md`

### Included Subtasks

- [x] T015 Implement `src/rag/search.py` - Simple documentation loader and searcher
- [x] T016 Implement `src/environment/tools.py` - Structure & `write_script` tool
- [x] T017 Implement `src/environment/tools.py` - `edit_script` tool (Regex/String replace)
- [x] T018 Implement `src/environment/tools.py` - `preview_design` tool (Graphics export)
- [x] T019 Implement `src/environment/tools.py` - `search_docs` wrapper

### Implementation Notes

- `preview_design` should result in an image file (PNG).
- RAG can just be a text search over markdown files for MVP.

### Parallel Opportunities

- T015 and T018 can be done in parallel.

### Dependencies

- WP01.

### Risks & Mitigations

- Rendering might require display; ensuring headless rendering works (e.g. EGL/OSMesa) if needed, or just standard software rendering.

---

## Work Package WP05: Core Environment Loop (Priority: P2)

**Goal**: Tie everything together into the Gymnasium interface and implement the complex `submit_design` flow.
**Independent Test**: Full Gym API works: reset, step, close. Agent can interact with the environment.
**Prompt**: `/tasks/WP05-core-environment-loop.md`

### Included Subtasks

- [x] T020 Implement `src/environment/core.py` - Class structure (Gymnasium inheritance)
- [x] T021 Implement `submit_design` logic in `core.py` (Compile -> Sim -> Reward)
- [x] T022 Integrate Persistence Layer (Logging steps and artifacts)
- [x] T023 Implement Observation construction (State assembly)
- [x] T024 Add Gym registration and entry point

### Implementation Notes

- This helps verify the "Success Criteria" of the whole spec.

### Dependencies

- WP01, WP02, WP03, WP04.

### Risks & Mitigations

- Integration complexity.

---

## Dependency & Execution Summary

- **Sequence**: WP01 → WP02/WP04 (Parallelable) → WP03 (Needs WP02) → WP05 (Needs All).
- **MVP Scope**: WP01 + WP02 + WP04 + WP05 (Sim bridge can be stubbed if needed, but WP03 is core to "Agentic CAD").

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Create project structure | WP01 | P0 | No |
| T002 | Initialize dependencies | WP01 | P0 | No |
| T003 | Configure linting | WP01 | P0 | Yes |
| T004 | DB Schema | WP01 | P0 | No |
| T005 | DB Access methods | WP01 | P0 | No |
| T006 | Geometry Export | WP02 | P1 | No |
| T007 | Convex Decomp | WP02 | P1 | No |
| T008 | Workbench ABC | WP02 | P1 | No |
| T009 | 3D Print Checks | WP02 | P1 | Yes |
| T010 | Cost Model | WP02 | P1 | Yes |
| T011 | Sim Client | WP03 | P1 | Yes |
| T012 | Request Payload | WP03 | P1 | No |
| T013 | Response Parsing | WP03 | P1 | No |
| T014 | Mock Sim Service | WP03 | P1 | Yes |
| T015 | RAG Search | WP04 | P2 | Yes |
| T016 | Tools Structure | WP04 | P2 | No |
| T017 | Edit Script | WP04 | P2 | No |
| T018 | Preview Design | WP04 | P2 | Yes |
| T019 | Search Docs Wrapper | WP04 | P2 | No |
| T020 | Gym Core | WP05 | P2 | No |
| T021 | Submit Logic | WP05 | P2 | No |
| T022 | Persistence Integration | WP05 | P2 | No |
| T023 | Observation | WP05 | P2 | No |
| T024 | Registration | WP05 | P2 | No |
