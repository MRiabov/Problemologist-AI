# Research: MuJoCo Simulation Engine

## 1. Isolation Strategy for Untrusted Agent Code

**Context**: The engine must execute Python control logic generated by an LLM-agent. This code could be buggy (infinite loops) or malicious (accessing filesystem).

**Options Considered**:

1. **Docker-in-Docker**: Spin up a container for every simulation.
    * *Pros*: Best security.
    * *Cons*: High latency (startup time > 1s), complex management.
2. **WebAssembly (Pyodide)**: Run Python in Wasm sandbox.
    * *Pros*: Perfect isolation.
    * *Cons*: Slow, might not support `numpy`/`mujoco` C-bindings easily or efficiently.
3. **Process-Isolation (`multiprocessing` / `subprocess`)**: Spawn a child process.
    * *Pros*: Low latency (<100ms), native performance, simple to implement.
    * *Cons*: Not a security boundary (can still access FS), but prevents Main Loop crash.

**Decision**: **Option 3 (Process Isolation)**.

* **Rationale**: We are running "Internal Agent" code, so malicious intent is low. The primary risk is *accidental* crashes or infinite loops. A separate process with a `timeout` and simple restrictions is sufficient and keeps the loop fast (Sim Speed goal: < 2s).

## 2. Mesh Collision Handling

**Context**: `build123d` outputs exact geometry, but MuJoCo physics prefers convex hulls for stable collision detection.

**Plan**:

1. Export `build123d` Compound to STL/OBJ (in-memory).
2. Load into `trimesh`.
3. Use `trimesh.convex.convex_hull` or `trimesh.decomposition.convex_decomposition` (VHACD) if concave.
4. Generate MJCF `<mesh>` assets.

**Decision**: Use `trimesh` convex hulls by default. If objects are complex (concave), assume the Agent is responsible for decomposing them in CAD or implement basic VHACD support in the builder.
